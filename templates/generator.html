<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPop Vocab Hunters</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/root.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/theme-wof.css') }}">
    <style>
        * { box-sizing: border-box; transition: all 0.3s ease; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 600px; padding: 2rem; }

        header { text-align: center; margin-bottom: 2.5rem; }

        h1 {
            font-size: 3rem; margin: 0;
            text-transform: uppercase; letter-spacing: 2px;
            font-weight: var(--header-font-weight);
            background: var(--btn-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 4px 15px rgba(0,0,0,0.5);
        }

        p.subtitle { font-size: 1rem; opacity: 0.8; margin-top: 0.5rem; letter-spacing: 1px; }

        .control-panel {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden;
        }

        .control-panel::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: var(--btn-gradient);
            box-shadow: var(--border-glow);
        }

        .main-layout { display: block; }
        .panel-form { width: 100%; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .full-width { grid-column: span 2; }

        label {
            display: block; margin-bottom: 0.5rem; font-size: 0.85rem;
            text-transform: uppercase; color: var(--accent-secondary);
            font-weight: bold; letter-spacing: 0.5px;
        }

        select, input {
            width: 100%; padding: 12px 16px;
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-color);
            font-family: inherit; font-size: 1rem;
            appearance: none; cursor: pointer;
        }

        select:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
        }

        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: '▼'; font-size: 0.7rem; position: absolute;
            right: 15px; top: 50%; transform: translateY(-50%);
            color: var(--accent-primary); pointer-events: none;
        }

        .generate-btn {
            grid-column: span 2; margin-top: 1.5rem; padding: 16px;
            background: var(--btn-gradient); border: none;
            border-radius: 8px; color: white;
            font-size: 1.1rem; font-weight: bold; text-transform: uppercase;
            cursor: pointer; box-shadow: var(--border-glow);
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0.6rem;
        }
        .generate-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .generate-btn.is-loading { cursor: wait; filter: brightness(1); transform: none; }
        .generate-btn:disabled { opacity: 0.7; }
        .spinner {
            width: 18px; height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.4);
            border-top-color: #fff;
            animation: spin 0.9s linear infinite;
            display: none;
        }
        .generate-btn.is-loading .spinner { display: inline-block; }
        .generate-btn.is-loading .btn-label { opacity: 0.85; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .footer { margin-top: 2rem; text-align: center; font-size: 0.8rem; opacity: 0.5; }
        .footer a {
            color: var(--accent-secondary);
            text-decoration: none;
            font-weight: bold;
        }
        .footer a:hover { text-decoration: underline; }

        .advanced-toggle {
            grid-column: span 2;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            background-color: rgba(0,0,0,0.15);
            padding: 0.75rem 1rem;
        }

        .advanced-toggle summary {
            list-style: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--accent-secondary);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .advanced-toggle summary::-webkit-details-marker { display: none; }

        .advanced-toggle summary::after {
            content: ">";
            font-size: 0.9rem;
            color: var(--accent-primary);
            transform: rotate(0deg);
            transition: transform 0.2s ease;
        }

        .advanced-toggle[open] summary::after { transform: rotate(90deg); }

        .advanced-content { margin-top: 1rem; }
        .advanced-content label { margin-top: 0.9rem; }
        .advanced-content label:first-child { margin-top: 0; }
        .advanced-content input { margin-top: 0.35rem; }
        .advanced-legend {
            margin-top: 0.75rem;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            background-color: rgba(0,0,0,0.12);
        }
        .advanced-legend summary {
            list-style: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
            color: var(--accent-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .advanced-legend summary::-webkit-details-marker { display: none; }
        .advanced-legend summary::after {
            content: ">";
            font-size: 0.75rem;
            color: var(--accent-primary);
            transform: rotate(0deg);
            transition: transform 0.2s ease;
        }
        .advanced-legend[open] summary::after { transform: rotate(90deg); }
        .advanced-legend .legend-body {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.4;
            opacity: 0.8;
        }
        .advanced-legend .legend-note { margin-bottom: 0.4rem; }
        .advanced-legend .legend-key {
            font-family: "Courier New", Courier, monospace;
            color: var(--accent-secondary);
        }

        .advanced-fieldset {
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 0.75rem 1rem 1rem;
            background-color: rgba(0,0,0,0.2);
        }

        .episode-list { margin-top: 1rem; }
        .episode-list-panel {
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
            max-height: 12rem;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .episode-list-items {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 0.5rem;
        }
        .episode-list-item {
            display: flex;
            gap: 0.6rem;
            align-items: center;
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .episode-pill {
            font-size: 1.0rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--accent-secondary);
            background: rgba(255,255,255,0.08);
            border-radius: 999px;
            padding: 0.2rem 0.5rem;
            margin-top: 0.1rem;
        }
        .episode-title {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.9;
        }
        .episode-subtitle {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.2rem;
        }
        .episode-preview-link {
            margin-left: auto;
            flex-shrink: 0;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            border-radius: 999px;
            background: transparent;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .episode-preview-link:hover {
            background: var(--accent-primary);
            color: #fff;
        }
        /* Loading Modal Styles */
        .loading-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.25);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loading-modal-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }

        /* Dim the content when loading */
        body.is-loading .container {
            opacity: 0.7;
            pointer-events: none;
            filter: blur(1px);
            transition: opacity 0.3s ease, filter 0.3s ease;
        }
        .loading-modal {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 3rem 4rem;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            max-width: 90vw;
            animation: modalPulse 2s ease-in-out infinite;
        }
        .loading-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--btn-gradient);
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes modalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes shimmer {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .loading-spinner-container {
            margin-bottom: 1.5rem;
        }
        .loading-spinner-big {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-secondary);
            animation: spinBig 1s linear infinite;
            margin: 0 auto;
            position: relative;
        }
        .loading-spinner-big::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-secondary);
            border-left-color: var(--accent-primary);
            animation: spinBig 0.6s linear reverse infinite;
        }
        @keyframes spinBig {
            to { transform: rotate(360deg); }
        }
        .loading-title {
            font-size: 1.6rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
            background: var(--btn-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loading-phrase {
            font-size: 1.1rem;
            color: var(--text-color);
            opacity: 0.9;
            min-height: 1.5em;
            animation: fadePhrase 0.4s ease-in-out;
        }
        @keyframes fadePhrase {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 0.9; transform: translateY(0); }
        }
        .loading-dots {
            display: inline-block;
            width: 24px;
            text-align: left;
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }
    </style>
</head>
<body class="{{ config.themes[0].css_class }}">

<div class="container">
    <header>
        <h1 id="ui-title">{{ config.themes[0].ui_title }}</h1>
        <p class="subtitle" id="ui-subtitle">{{ config.themes[0].ui_subtitle }}</p>
    </header>

    <div class="main-layout">
        <div class="control-panel">
            <form class="grid panel-form" action="/generate" method="POST">
                <div class="full-width">
                    <label for="theme">Theme</label>
                    <div class="select-wrapper">
                        <select id="theme" name="theme" onchange="changeTheme()">
                            {% for theme in config.themes %}
                            <option value="{{ theme.id }}">{{ theme.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="full-width">
                    <label for="datasource">Source</label>
                    <div class="select-wrapper">
                        <select id="datasource" name="datasource" onchange="changeSourceDataset()">
                            {% for source in config.data_sources %}
                            <option value="{{ source.id }}">{{ source.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label for="section">Section</label>
                    <div class="select-wrapper">
                        <select id="section" name="section">
                            {% for num in config.sections %}
                            <option value="{{ num }}">{{ num }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label for="level">Reading Level</label>
                    <div class="select-wrapper">
                        <select id="level" name="level">
                            {% for letter in config.levels %}
                            <option value="{{ letter }}" {% if letter == "P" %}selected{% endif %}>{{ letter }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <details class="advanced-toggle">
                    <summary>Advanced</summary>
                    <div class="advanced-content">
                        <div class="advanced-fieldset">
                            <label for="header_text">Header Text</label>
                            <input id="header_text" name="header_text" type="text" placeholder="{theme} - Section {section}">

                            <label for="footer_text">Footer Text</label>
                            <input id="footer_text" name="footer_text" type="text" placeholder="Page {current_page} of {total_pages}">

                            <label for="answer_key_footer">Answer Key Footer</label>
                            <input id="answer_key_footer" name="answer_key_footer" type="text" placeholder="Fountas & Pinnell Level {reading_level}">
                            
                            <details class="advanced-legend">
                                <summary>Label Variables</summary>
                                <div class="legend-body" aria-label="Text field variable legend">
                                    <div class="legend-note">Use any of these variables within the above labels:</div>
                                    <div><span class="legend-key">{source}</span>: Full data-source title</div>
                                    <div><span class="legend-key">{source_abbr}</span>: Abbreviated data-source title</div>
                                    <div><span class="legend-key">{theme}</span>: Full theme title</div>
                                    <div><span class="legend-key">{theme_abbr}</span>: Abbreviated theme title</div>
                                    <div><span class="legend-key">{section}</span>: Section # within the data source</div>
                                    <div><span class="legend-key">{episode}</span>: Episode #</div>
                                    <div><span class="legend-key">{reading_level}</span>: F&amp;P reading level</div>
                                    <div><span class="legend-key">{worksheet_id}</span>: Unique worksheet identifier</div>
                                    <div><span class="legend-key">{current_page}</span>: Page number within worksheet</div>
                                    <div><span class="legend-key">{total_pages}</span>: Total worksheet pages</div>
                                    <div><span class="legend-key">{model}</span>: Model identifier</div>
                                </div>
                            </details>
                        </div>

                        <label for="model">Model</label>
                        <div class="select-wrapper">
                            <select id="model" name="model">
                                {% for model in config.models %}
                                <option value="{{ model.id }}" {% if model.is_default %}selected{% endif %}>{{ model.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </details>

                <div id="episode-list-container" class="episode-list full-width" hidden>
                    <label>Browse Past Episodes</label>
                    <div class="episode-list-panel" role="region" aria-label="Browse Past Episodes">
                        <ul id="episode_list" class="episode-list-items"></ul>
                    </div>
                </div>

                <button id="generate-btn" type="submit" class="generate-btn">
                    <span class="btn-label">Generate Episode</span>
                    <span class="spinner" aria-hidden="true"></span>
                </button>

            </form>
        </div>

    </div>

    <div class="footer">
        <a href="/">Home</a> · <a href="/about">About</a>
    </div>
</div>

<script>
    // Pass Python theme config to JavaScript
    const themeConfig = {
        {% for theme in config.themes %}
        "{{ theme.id }}": {
            "title": "{{ theme.ui_title }}",
            "subtitle": "{{ theme.ui_subtitle }}",

            "css_class": "{{ theme.css_class }}"
        },
        {% endfor %}
    };

    const worksheetParams = {{ worksheet_params | tojson }} || null;

    // Silly loading phrases
    const loadingPhrases = [
        "Warming up the AI brain",
        "Teaching vocabulary to robots",
        "Consulting the word wizards",
        "Brewing a fresh batch of sentences",
        "Asking the thesaurus for directions",
        "Sharpening the digital pencils",
        "Convincing electrons to form words",
        "Summoning the grammar gremlins",
        "Downloading extra creativity",
        "Untangling the syntax spaghetti",
        "Polishing the vocabulary gems",
        "Waking up the sentence elves",
        "Calibrating the fun-o-meter",
        "Herding the alphabet cats",
        "Spinning up the word tornado",
        "Feeding the hungry algorithms",
        "Consulting ancient dictionaries",
        "Negotiating with the punctuation union",
        "Assembling the sentence squad",
        "Loading extra awesome sauce",
        "Tuning the linguistic engines",
        "Asking nicely for good answers",
        "Bribing the AI with cookies",
        "Stretching the neural networks",
        "Doing vocabulary jumping jacks"
    ];

    let loadingPhraseInterval = null;
    let currentPhraseIndex = 0;

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function showLoadingModal() {
        const modal = document.getElementById('loading-modal');
        const phraseText = document.getElementById('loading-phrase-text');
        if (!modal) return;

        // Shuffle phrases and start from beginning
        const shuffledPhrases = shuffleArray(loadingPhrases);
        currentPhraseIndex = 0;

        // Set initial phrase
        if (phraseText) {
            phraseText.textContent = shuffledPhrases[currentPhraseIndex];
        }

        // Dim the content behind
        document.body.classList.add('is-loading');

        // Show modal
        modal.classList.add('is-visible');
        modal.setAttribute('aria-hidden', 'false');

        // Rotate phrases every 2.5 seconds
        loadingPhraseInterval = setInterval(() => {
            currentPhraseIndex = (currentPhraseIndex + 1) % shuffledPhrases.length;
            if (phraseText) {
                phraseText.style.animation = 'none';
                phraseText.offsetHeight; // Trigger reflow
                phraseText.style.animation = 'fadePhrase 0.4s ease-in-out';
                phraseText.textContent = shuffledPhrases[currentPhraseIndex];
            }
        }, 2500);
    }

    function hideLoadingModal() {
        const modal = document.getElementById('loading-modal');
        if (!modal) return;

        // Stop phrase rotation
        if (loadingPhraseInterval) {
            clearInterval(loadingPhraseInterval);
            loadingPhraseInterval = null;
        }

        // Undim the content
        document.body.classList.remove('is-loading');

        // Hide modal
        modal.classList.remove('is-visible');
        modal.setAttribute('aria-hidden', 'true');
    }

    function changeTheme() {
        const selectedId = document.getElementById('theme').value;
        const currentTheme = themeConfig[selectedId];
        
        // Update Text
        document.getElementById('ui-title').innerText = currentTheme.title;
        document.getElementById('ui-subtitle').innerText = currentTheme.subtitle;

        // Reset classes and apply new theme class
        document.body.className = currentTheme.css_class;
    }

    function getPreferenceSnapshot() {
        return {
            theme: document.getElementById('theme').value,
            datasource: document.getElementById('datasource').value,
            section: document.getElementById('section').value,
            level: document.getElementById('level').value,
            model: document.getElementById('model').value
        };
    }

    function savePreferences() {
        try {
            localStorage.setItem('homeworkHeroPrefs', JSON.stringify(getPreferenceSnapshot()));
        } catch (err) {
            // Ignore storage issues (private mode, quota, etc.)
        }
    }

    function loadPreferences() {
        try {
            const raw = localStorage.getItem('homeworkHeroPrefs');
            return raw ? JSON.parse(raw) : null;
        } catch (err) {
            return null;
        }
    }

    function updateGenerateButton(hasEpisodes) {
        const button = document.getElementById('generate-btn');
        if (!button) {
            return;
        }
        const label = button.querySelector('.btn-label');
        if (label) {
            label.textContent = hasEpisodes ? 'Generate New Episode' : 'Generate Episode';
        }
    }

    let isGenerating = false;

    function setGenerateLoading(isLoading) {
        const button = document.getElementById('generate-btn');
        if (!button) {
            return;
        }
        isGenerating = isLoading;
        button.classList.toggle('is-loading', isLoading);
        button.disabled = isLoading;
        button.setAttribute('aria-busy', isLoading ? 'true' : 'false');

        // Show/hide the loading modal
        if (isLoading) {
            showLoadingModal();
        } else {
            hideLoadingModal();
        }
    }

    async function handleGenerate(event) {
        event.preventDefault();
        if (isGenerating) {
            return;
        }
        const headerInput = document.getElementById('header_text');
        const footerInput = document.getElementById('footer_text');
        const answerKeyFooterInput = document.getElementById('answer_key_footer');
        const headerValue = (headerInput && headerInput.value.trim()) || (headerInput && headerInput.placeholder) || '';
        const footerValue = (footerInput && footerInput.value.trim()) || (footerInput && footerInput.placeholder) || '';
        const answerKeyFooterValue = (answerKeyFooterInput && answerKeyFooterInput.value.trim())
            || (answerKeyFooterInput && answerKeyFooterInput.placeholder)
            || '';
        const payload = {
            datasource: document.getElementById('datasource').value,
            theme: document.getElementById('theme').value,
            level: document.getElementById('level').value,
            model: document.getElementById('model').value,
            section: document.getElementById('section').value,
            header_text: headerValue,
            footer_text: footerValue,
            answer_key_footer: answerKeyFooterValue
        };
        setGenerateLoading(true);
        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    const errorPayload = await response.json();
                    throw new Error(errorPayload.error || 'Generate failed.');
                }
                throw new Error('Generate failed.');
            }
            const worksheetId = response.headers.get('X-Worksheet-Id');
            if (worksheetId) {
                window.location.href = '/worksheet?id=' + encodeURIComponent(worksheetId);
                return;
            }
        } catch (err) {
            // Optional: surface error state in a future UI block.
        } finally {
            setGenerateLoading(false);
        }
    }

    async function updateEpisodes() {
        const container = document.getElementById('episode-list-container');
        const list = document.getElementById('episode_list');
        if (!container || !list) {
            return;
        }
        const sourceDataset = document.getElementById('datasource').value;
        const theme = document.getElementById('theme').value;
        const readingLevel = document.getElementById('level').value;
        const model = document.getElementById('model').value;
        const section = document.getElementById('section').value;

        const params = new URLSearchParams({
            source_dataset: sourceDataset,
            theme: theme,
            reading_level: readingLevel,
            model: model,
            section: section
        });

        try {
            const response = await fetch(`/episodes?${params.toString()}`);
            if (!response.ok) {
                throw new Error('Failed to fetch episodes.');
            }
            const payload = await response.json();
            const episodes = payload.episodes || [];
            if (!episodes.length) {
                container.hidden = true;
                list.innerHTML = '';
                updateGenerateButton(false);
                return;
            }
            container.hidden = false;
            list.innerHTML = '';
            episodes.forEach((episode) => {
                const entry = document.createElement('li');
                entry.className = 'episode-list-item';

                const episodeNumber = episode.episode ?? episode;
                const episodeSubtitle = (episode && typeof episode === 'object' && episode.subtitle) ? episode.subtitle : '';
                entry.dataset.episode = `${episodeNumber}`;
                entry.dataset.subtitle = episodeSubtitle;

                const pill = document.createElement('span');
                pill.className = 'episode-pill';
                pill.textContent = `#${episodeNumber}`;
                entry.appendChild(pill);

                const content = document.createElement('div');
                content.className = 'episode-title';
                if (episodeSubtitle) {
                    content.textContent = episodeSubtitle;
                }

                entry.appendChild(content);

                const worksheetId = (episode && typeof episode === 'object') ? episode.worksheet_id : null;
                if (worksheetId) {
                    const worksheetUrl = '/worksheet?id=' + encodeURIComponent(worksheetId);
                    entry.style.cursor = 'pointer';
                    entry.addEventListener('click', () => { window.location.href = worksheetUrl; });

                    const previewLink = document.createElement('a');
                    previewLink.className = 'episode-preview-link';
                    previewLink.href = worksheetUrl;
                    previewLink.textContent = 'View';
                    entry.appendChild(previewLink);
                }

                list.appendChild(entry);
            });
            updateGenerateButton(true);
        } catch (err) {
            container.hidden = true;
            list.innerHTML = '';
            updateGenerateButton(false);
        }
    }

    async function changeSourceDataset() {
        const selectedId = document.getElementById('datasource').value;
        try {
            const response = await fetch(`/sections/${encodeURIComponent(selectedId)}`);
            const payload = await response.json();
            if (!response.ok) {
                return;
            }
            const sectionSelect = document.getElementById('section');
            sectionSelect.innerHTML = '';
            (payload.sections || []).forEach((num) => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = num;
                sectionSelect.appendChild(option);
            });
        } catch (err) {
            // Keep existing sections if the request fails.
        }
        updateEpisodes();
    }

    window.addEventListener('DOMContentLoaded', () => {
        const themeSelect = document.getElementById('theme');
        const sourceSelect = document.getElementById('datasource');
        const sectionSelect = document.getElementById('section');
        const levelSelect = document.getElementById('level');
        const modelSelect = document.getElementById('model');
        const generateForm = document.querySelector('.panel-form');

        if (worksheetParams) {
            // Pre-populate from worksheet URL params
            if (worksheetParams.theme) {
                themeSelect.value = worksheetParams.theme;
                changeTheme();
            }
            if (worksheetParams.source_dataset) {
                sourceSelect.value = worksheetParams.source_dataset;
            }
            if (worksheetParams.reading_level) {
                levelSelect.value = worksheetParams.reading_level;
            }
            if (worksheetParams.model) {
                modelSelect.value = worksheetParams.model;
            }

            changeSourceDataset().then(() => {
                if (worksheetParams.section != null) {
                    sectionSelect.value = worksheetParams.section;
                }
                updateEpisodes();
            });
        } else {
            const saved = loadPreferences();
            if (saved) {
                if (saved.theme) {
                    themeSelect.value = saved.theme;
                    changeTheme();
                }
                if (saved.datasource) {
                    sourceSelect.value = saved.datasource;
                }
                if (saved.level) {
                    levelSelect.value = saved.level;
                }
                if (saved.model) {
                    modelSelect.value = saved.model;
                }
            }

            changeSourceDataset().then(() => {
                if (saved && saved.section) {
                    sectionSelect.value = saved.section;
                }
                updateEpisodes();
            });
        }

        themeSelect.addEventListener('change', () => {
            changeTheme();
            savePreferences();
            updateEpisodes();
        });
        sourceSelect.addEventListener('change', () => {
            changeSourceDataset();
            savePreferences();
        });
        levelSelect.addEventListener('change', () => {
            savePreferences();
            updateEpisodes();
        });
        sectionSelect.addEventListener('change', () => {
            savePreferences();
            updateEpisodes();
        });
        modelSelect.addEventListener('change', () => {
            savePreferences();
            updateEpisodes();
        });

        if (generateForm) {
            generateForm.addEventListener('submit', handleGenerate);
        }
    });
</script>

<!-- Loading Modal -->
<div id="loading-modal" class="loading-modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-phrase">
    <div class="loading-modal">
        <div class="loading-spinner-container">
            <div class="loading-spinner-big"></div>
        </div>
        <div id="loading-title" class="loading-title">Building Episode</div>
        <div id="loading-phrase" class="loading-phrase">
            <span id="loading-phrase-text">Warming up the AI brain</span><span class="loading-dots"></span>
        </div>
    </div>
</div>

</body>
</html>
