<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksheet Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/root.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/theme-wof.css') }}">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ── Top Bar ── */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 1rem;
            background: var(--card-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            gap: 0.75rem;
        }

        .top-bar-left, .top-bar-right {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
        }

        .top-bar-center {
            flex: 1;
            text-align: center;
            min-width: 0;
        }

        .top-bar-title {
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--btn-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-bar-episode {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.1rem;
        }

        .bar-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .bar-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--accent-primary);
        }

        .bar-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* ── Main Area ── */
        .main-area {
            flex: 1;
            display: flex;
            align-items: stretch;
            min-height: 0;
        }

        .nav-arrow {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s, background 0.2s;
            text-decoration: none;
        }

        .nav-arrow:hover {
            opacity: 1;
            background: rgba(255,255,255,0.05);
        }

        .nav-arrow.disabled {
            opacity: 0.15;
            pointer-events: none;
            cursor: default;
        }

        .nav-arrow.generate-next {
            position: relative;
        }

        .nav-arrow.generate-next::after {
            content: '+';
            position: absolute;
            bottom: 40%;
            right: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--accent-secondary);
        }

        .nav-arrow svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        .pdf-container {
            flex: 1;
            min-width: 0;
            background: #fff;
        }

        .pdf-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
        }

        /* ── Pagination Bar ── */
        .pagination-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.6rem 1rem;
            background: var(--card-bg);
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .page-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 0 0.5rem;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            flex-shrink: 0;
        }

        .page-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--accent-primary);
        }

        .page-btn.active {
            background: var(--btn-gradient);
            border-color: transparent;
            color: #fff;
            cursor: default;
            box-shadow: var(--border-glow);
        }

        .page-ellipsis {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 36px;
            font-size: 0.85rem;
            opacity: 0.4;
            flex-shrink: 0;
        }

        /* ── Loading Modal Styles ── */
        .loading-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.25);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loading-modal-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }

        /* Dim the content when loading */
        body.is-loading .top-bar,
        body.is-loading .main-area,
        body.is-loading .pagination-bar {
            opacity: 0.7;
            pointer-events: none;
            filter: blur(1px);
            transition: opacity 0.3s ease, filter 0.3s ease;
        }
        .loading-modal {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 3rem 4rem;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            max-width: 90vw;
            animation: modalPulse 2s ease-in-out infinite;
        }
        .loading-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--btn-gradient);
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes modalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes shimmer {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .loading-spinner-container {
            margin-bottom: 1.5rem;
        }
        .loading-spinner-big {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-secondary);
            animation: spinBig 1s linear infinite;
            margin: 0 auto;
            position: relative;
        }
        .loading-spinner-big::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-secondary);
            border-left-color: var(--accent-primary);
            animation: spinBig 0.6s linear reverse infinite;
        }
        @keyframes spinBig {
            to { transform: rotate(360deg); }
        }
        .loading-title {
            font-size: 1.6rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
            background: var(--btn-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loading-phrase {
            font-size: 1.1rem;
            color: var(--text-color);
            opacity: 0.9;
            min-height: 1.5em;
            animation: fadePhrase 0.4s ease-in-out;
        }
        @keyframes fadePhrase {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 0.9; transform: translateY(0); }
        }
        .loading-dots {
            display: inline-block;
            width: 24px;
            text-align: left;
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }

        /* ── Mobile ── */
        @media (max-width: 600px) {
            .nav-arrow { width: 40px; }
            .nav-arrow svg { width: 22px; height: 22px; }
            .top-bar { padding: 0.5rem 0.6rem; }
            .top-bar-title { font-size: 0.95rem; }
            .bar-btn { padding: 0.4rem 0.7rem; font-size: 0.8rem; }
            .bar-btn .btn-text { display: none; }
        }
    </style>
</head>
<body class="{{ viewer.theme_entry.css_class if viewer.theme_entry else '' }}">

<!-- Top Bar -->
<div class="top-bar">
    <div class="top-bar-left">
        <a href="/worksheets" class="bar-btn">
            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            <span class="btn-text">Back</span>
        </a>
    </div>
    <div class="top-bar-center">
        <div class="top-bar-title">{{ viewer.theme_entry.ui_title if viewer.theme_entry else 'Worksheet' }}</div>
        <div class="top-bar-episode">Episode {{ viewer.params.seed }} &middot; Section {{ viewer.params.section }}</div>
    </div>
    <div class="top-bar-right">
        <a href="/worksheet_pdf?id={{ viewer.worksheet_id }}" download="{{ viewer.pdf_filename }}" class="bar-btn">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            <span class="btn-text">Download</span>
        </a>
    </div>
</div>

<!-- Main Area -->
<div class="main-area">
    {% if viewer.prev_worksheet_id %}
    <a href="/worksheet?id={{ viewer.prev_worksheet_id }}" class="nav-arrow" title="Previous episode">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </a>
    {% else %}
    <span class="nav-arrow disabled">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </span>
    {% endif %}

    <div class="pdf-container">
        <iframe id="pdf-frame" {% if viewer.episode_exists %}src="/worksheet_pdf?id={{ viewer.worksheet_id }}"{% endif %} title="Worksheet PDF"></iframe>
    </div>

    {% if viewer.next_worksheet_id %}
    <a href="/worksheet?id={{ viewer.next_worksheet_id }}" class="nav-arrow" title="Next episode">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </a>
    {% elif viewer.next_is_generate %}
    <button id="generate-next-btn" class="nav-arrow generate-next" title="Generate Episode {{ viewer.next_generate_episode }}">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </button>
    {% else %}
    <span class="nav-arrow disabled">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </span>
    {% endif %}
</div>

<!-- Pagination Bar -->
<div class="pagination-bar" id="pagination-bar">
    {% set episodes = viewer.episodes %}
    {% set current_seed = viewer.params.seed %}
    {% set total = episodes | length %}
    {% set current_idx = namespace(val=0) %}
    {% for ep in episodes %}
        {% if ep.episode == current_seed %}
            {% set current_idx.val = loop.index0 %}
        {% endif %}
    {% endfor %}

    {% if total <= 7 %}
        {# Show all #}
        {% for ep in episodes %}
            {% if ep.episode == current_seed %}
                <span class="page-btn active">{{ ep.episode }}</span>
            {% else %}
                <a href="/worksheet?id={{ ep.worksheet_id }}" class="page-btn">{{ ep.episode }}</a>
            {% endif %}
        {% endfor %}
    {% else %}
        {# Smart pagination: first, ..., neighbors, ..., last #}
        {% set ci = current_idx.val %}
        {% set show = namespace(indices=[]) %}

        {# Always include first and last #}
        {% set show.indices = [0, total - 1] %}

        {# Include neighbors of current #}
        {% for offset in [-1, 0, 1] %}
            {% set idx = ci + offset %}
            {% if idx >= 0 and idx < total and idx not in show.indices %}
                {% set show.indices = show.indices + [idx] %}
            {% endif %}
        {% endfor %}

        {# Sort indices #}
        {% set show.indices = show.indices | sort %}

        {% set prev_idx = namespace(val=-2) %}
        {% for idx in show.indices %}
            {% if idx - prev_idx.val > 1 %}
                <span class="page-ellipsis">&hellip;</span>
            {% endif %}
            {% set ep = episodes[idx] %}
            {% if ep.episode == current_seed %}
                <span class="page-btn active">{{ ep.episode }}</span>
            {% else %}
                <a href="/worksheet?id={{ ep.worksheet_id }}" class="page-btn">{{ ep.episode }}</a>
            {% endif %}
            {% set prev_idx.val = idx %}
        {% endfor %}
    {% endif %}
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="loading-modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-phrase">
    <div class="loading-modal">
        <div class="loading-spinner-container">
            <div class="loading-spinner-big"></div>
        </div>
        <div id="loading-title" class="loading-title">Building Episode</div>
        <div id="loading-phrase" class="loading-phrase">
            <span id="loading-phrase-text">Warming up the AI brain</span><span class="loading-dots"></span>
        </div>
    </div>
</div>

<script>
    const viewerData = {{ viewer | tojson }};

    // Silly loading phrases
    const loadingPhrases = [
        "Warming up the AI brain",
        "Teaching vocabulary to robots",
        "Consulting the word wizards",
        "Brewing a fresh batch of sentences",
        "Asking the thesaurus for directions",
        "Sharpening the digital pencils",
        "Convincing electrons to form words",
        "Summoning the grammar gremlins",
        "Downloading extra creativity",
        "Untangling the syntax spaghetti",
        "Polishing the vocabulary gems",
        "Waking up the sentence elves",
        "Calibrating the fun-o-meter",
        "Herding the alphabet cats",
        "Spinning up the word tornado",
        "Feeding the hungry algorithms",
        "Consulting ancient dictionaries",
        "Negotiating with the punctuation union",
        "Assembling the sentence squad",
        "Loading extra awesome sauce",
        "Tuning the linguistic engines",
        "Asking nicely for good answers",
        "Bribing the AI with cookies",
        "Stretching the neural networks",
        "Doing vocabulary jumping jacks"
    ];

    let loadingPhraseInterval = null;
    let currentPhraseIndex = 0;

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function showLoadingModal() {
        const modal = document.getElementById('loading-modal');
        const phraseText = document.getElementById('loading-phrase-text');
        if (!modal) return;

        const shuffledPhrases = shuffleArray(loadingPhrases);
        currentPhraseIndex = 0;

        if (phraseText) {
            phraseText.textContent = shuffledPhrases[currentPhraseIndex];
        }

        document.body.classList.add('is-loading');
        modal.classList.add('is-visible');
        modal.setAttribute('aria-hidden', 'false');

        loadingPhraseInterval = setInterval(() => {
            currentPhraseIndex = (currentPhraseIndex + 1) % shuffledPhrases.length;
            if (phraseText) {
                phraseText.style.animation = 'none';
                phraseText.offsetHeight; // Trigger reflow
                phraseText.style.animation = 'fadePhrase 0.4s ease-in-out';
                phraseText.textContent = shuffledPhrases[currentPhraseIndex];
            }
        }, 2500);
    }

    function hideLoadingModal() {
        const modal = document.getElementById('loading-modal');
        if (!modal) return;

        if (loadingPhraseInterval) {
            clearInterval(loadingPhraseInterval);
            loadingPhraseInterval = null;
        }

        document.body.classList.remove('is-loading');
        modal.classList.remove('is-visible');
        modal.setAttribute('aria-hidden', 'true');
    }

    // ── Page State ──
    const SEED_BITS = 8;
    const MAX_SEED = (1 << SEED_BITS) - 1;

    const PREV_ARROW_SVG = '<svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>';
    const NEXT_ARROW_SVG = '<svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>';

    const pageState = {
        worksheetId: viewerData.worksheet_id,
        episode: viewerData.params.seed,
        episodes: viewerData.episodes,
        prevWorksheetId: viewerData.prev_worksheet_id,
        nextWorksheetId: viewerData.next_worksheet_id,
        nextIsGenerate: viewerData.next_is_generate,
        nextGenerateEpisode: viewerData.next_generate_episode,
    };

    // ── UI Update Functions ──
    function updateIframe() {
        const frame = document.getElementById('pdf-frame');
        if (frame) frame.src = '/worksheet_pdf?id=' + encodeURIComponent(pageState.worksheetId);
    }

    function updateHeader() {
        const el = document.querySelector('.top-bar-episode');
        if (el) el.innerHTML = 'Episode ' + pageState.episode + ' &middot; Section ' + viewerData.params.section;
    }

    function buildPdfFilename(episode) {
        const config = {{ config | tojson }};
        const params = viewerData.params;
        let sourceAbbr = params.source_dataset;
        for (const ds of config.data_sources) {
            if (ds.id === params.source_dataset) {
                sourceAbbr = ds.title_abbr || ds.key_name || params.source_dataset;
                break;
            }
        }
        let themeAbbr = params.theme;
        for (const t of config.themes) {
            if (t.id === params.theme) {
                themeAbbr = t.title_abbr || t.key_name || params.theme;
                break;
            }
        }
        const sanitize = s => s.replace(/ /g, '_').replace(/\//g, '-');
        return sanitize(sourceAbbr) + '-' + sanitize(themeAbbr) + '-S' + params.section + '-E' + episode + '.pdf';
    }

    function updateDownloadLink() {
        const link = document.querySelector('.top-bar-right .bar-btn');
        if (link) {
            link.href = '/worksheet_pdf?id=' + encodeURIComponent(pageState.worksheetId);
            link.download = buildPdfFilename(pageState.episode);
        }
    }

    function updateNavArrows() {
        const mainArea = document.querySelector('.main-area');
        if (!mainArea) return;

        const children = mainArea.children;
        const prevArrow = children[0];
        const nextArrow = children[children.length - 1];

        // Rebuild prev arrow
        let newPrev;
        if (pageState.prevWorksheetId) {
            newPrev = document.createElement('a');
            newPrev.href = '/worksheet?id=' + encodeURIComponent(pageState.prevWorksheetId);
            newPrev.className = 'nav-arrow';
            newPrev.title = 'Previous episode';
        } else {
            newPrev = document.createElement('span');
            newPrev.className = 'nav-arrow disabled';
        }
        newPrev.innerHTML = PREV_ARROW_SVG;
        mainArea.replaceChild(newPrev, prevArrow);

        // Rebuild next arrow
        let newNext;
        if (pageState.nextWorksheetId) {
            newNext = document.createElement('a');
            newNext.href = '/worksheet?id=' + encodeURIComponent(pageState.nextWorksheetId);
            newNext.className = 'nav-arrow';
            newNext.title = 'Next episode';
        } else if (pageState.nextIsGenerate) {
            newNext = document.createElement('button');
            newNext.id = 'generate-next-btn';
            newNext.className = 'nav-arrow generate-next';
            newNext.title = 'Generate Episode ' + pageState.nextGenerateEpisode;
            newNext.addEventListener('click', handleGenerateClick);
        } else {
            newNext = document.createElement('span');
            newNext.className = 'nav-arrow disabled';
        }
        newNext.innerHTML = NEXT_ARROW_SVG;
        mainArea.replaceChild(newNext, nextArrow);
    }

    function updatePaginationBar() {
        const bar = document.getElementById('pagination-bar');
        if (!bar) return;

        const episodes = pageState.episodes;
        const current = pageState.episode;
        const total = episodes.length;
        let html = '';

        if (total <= 7) {
            for (const ep of episodes) {
                if (ep.episode === current) {
                    html += '<span class="page-btn active">' + ep.episode + '</span>';
                } else {
                    html += '<a href="/worksheet?id=' + encodeURIComponent(ep.worksheet_id) + '" class="page-btn">' + ep.episode + '</a>';
                }
            }
        } else {
            const ci = episodes.findIndex(ep => ep.episode === current);
            const indices = new Set([0, total - 1]);
            for (const offset of [-1, 0, 1]) {
                const idx = ci + offset;
                if (idx >= 0 && idx < total) indices.add(idx);
            }
            const sorted = Array.from(indices).sort((a, b) => a - b);

            let prevIdx = -2;
            for (const idx of sorted) {
                if (idx - prevIdx > 1) {
                    html += '<span class="page-ellipsis">&hellip;</span>';
                }
                const ep = episodes[idx];
                if (ep.episode === current) {
                    html += '<span class="page-btn active">' + ep.episode + '</span>';
                } else {
                    html += '<a href="/worksheet?id=' + encodeURIComponent(ep.worksheet_id) + '" class="page-btn">' + ep.episode + '</a>';
                }
                prevIdx = idx;
            }
        }

        bar.innerHTML = html;
    }

    // ── Generate Handler ──
    async function handleGenerateClick() {
        const btn = document.getElementById('generate-next-btn');
        if (!btn || btn.disabled) return;

        showLoadingModal();
        btn.disabled = true;

        const payload = {
            source_dataset: viewerData.params.source_dataset,
            theme: viewerData.params.theme,
            level: viewerData.params.reading_level,
            model: viewerData.params.model,
            section: viewerData.params.section,
            presentation_metadata: {
                header: '{theme} - Section {section}',
                footer: 'Page {current_page} of {total_pages}',
                answer_key_footer: 'Fountas & Pinnell Level {reading_level}',
            },
        };

        try {
            // Generate the new episode on the server
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) throw new Error('Generate failed');

            // Fetch updated episodes list to get the new episode's worksheet ID
            const newEpisode = pageState.nextGenerateEpisode;
            await fetchAndUpdateEpisodes();

            const newEpEntry = pageState.episodes.find(ep => ep.episode === newEpisode);
            if (!newEpEntry || !newEpEntry.worksheet_id) throw new Error('New episode not found in list');
            const newId = newEpEntry.worksheet_id;

            // Advance state to the new episode and recompute nav locally
            pageState.worksheetId = newId;
            pageState.episode = newEpisode;
            recomputeNavState();

            // Update all UI elements in place
            updateIframe();
            updateHeader();
            updateDownloadLink();
            updateNavArrows();
            updatePaginationBar();

            // Update browser URL without full navigation
            history.pushState(null, '', '/worksheet?id=' + encodeURIComponent(newId));

            hideLoadingModal();
        } catch (err) {
            console.error('Generate failed:', err);
            hideLoadingModal();
            if (btn) btn.disabled = false;
        }
    }

    // ── Shared: recompute prev/next nav from current episodes + episode ──
    function recomputeNavState() {
        const episodes = pageState.episodes;
        const currentIdx = episodes.findIndex(ep => ep.episode === pageState.episode);
        pageState.prevWorksheetId = currentIdx > 0 ? episodes[currentIdx - 1].worksheet_id : null;

        if (currentIdx >= 0 && currentIdx < episodes.length - 1) {
            pageState.nextWorksheetId = episodes[currentIdx + 1].worksheet_id;
            pageState.nextIsGenerate = false;
            pageState.nextGenerateEpisode = null;
        } else {
            pageState.nextWorksheetId = null;
            const lastEp = episodes.length > 0 ? episodes[episodes.length - 1].episode : 0;
            if (lastEp < MAX_SEED) {
                pageState.nextIsGenerate = true;
                pageState.nextGenerateEpisode = lastEp + 1;
            } else {
                pageState.nextIsGenerate = false;
                pageState.nextGenerateEpisode = null;
            }
        }
    }

    // ── Shared: fetch episodes list from server and update nav state ──
    async function fetchAndUpdateEpisodes() {
        const epParams = new URLSearchParams({
            source_dataset: viewerData.params.source_dataset,
            theme: viewerData.params.theme,
            reading_level: viewerData.params.reading_level,
            model: viewerData.params.model,
            section: String(viewerData.params.section),
        });
        const epResponse = await fetch('/episodes?' + epParams.toString());
        if (!epResponse.ok) throw new Error('Failed to fetch episodes');
        const epData = await epResponse.json();
        pageState.episodes = epData.episodes || [];
        recomputeNavState();
    }

    // ── Generate missing episode (QR code for uncached episode) ──
    async function generateMissingEpisode() {
        showLoadingModal();
        try {
            // Trigger generation via worksheet_pdf (generates any specific episode)
            const pdfResponse = await fetch('/worksheet_pdf?id=' + encodeURIComponent(pageState.worksheetId));
            if (!pdfResponse.ok) throw new Error('PDF generation failed');

            // Load the PDF into the iframe using a blob URL
            const pdfBytes = await pdfResponse.arrayBuffer();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const frame = document.getElementById('pdf-frame');
            if (frame) frame.src = URL.createObjectURL(blob);

            // Fetch updated episodes and update navigation state
            await fetchAndUpdateEpisodes();

            updateNavArrows();
            updatePaginationBar();
            hideLoadingModal();
        } catch (err) {
            console.error('Episode generation failed:', err);
            hideLoadingModal();
        }
    }

    // Attach handler to initial generate button (if present)
    const initialGenerateBtn = document.getElementById('generate-next-btn');
    if (initialGenerateBtn) {
        initialGenerateBtn.addEventListener('click', handleGenerateClick);
    }

    // If the episode doesn't exist yet, generate it on page load
    if (!viewerData.episode_exists) {
        generateMissingEpisode();
    }

    // Handle browser back/forward after pushState
    window.addEventListener('popstate', () => {
        window.location.reload();
    });
</script>

</body>
</html>
